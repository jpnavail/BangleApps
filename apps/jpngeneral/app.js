require("Font8x12").add(Graphics);

Graphics.prototype.setFontAnton = function(scale) {
  // Actual height 69 (68 - 0)
  g.setFontCustom(atob("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAA/gAAAAAAAAAAP/gAAAAAAAAAH//gAAAAAAAAB///gAAAAAAAAf///gAAAAAAAP////gAAAAAAD/////gAAAAAA//////gAAAAAP//////gAAAAH///////gAAAB////////gAAAf////////gAAP/////////gAD//////////AA//////////gAA/////////4AAA////////+AAAA////////gAAAA///////wAAAAA//////8AAAAAA//////AAAAAAA/////gAAAAAAA////4AAAAAAAA///+AAAAAAAAA///gAAAAAAAAA//wAAAAAAAAAA/8AAAAAAAAAAA/AAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//////AAAAAB///////8AAAAH////////AAAAf////////wAAA/////////4AAB/////////8AAD/////////+AAH//////////AAP//////////gAP//////////gAP//////////gAf//////////wAf//////////wAf//////////wAf//////////wA//8AAAAAB//4A//wAAAAAAf/4A//gAAAAAAP/4A//gAAAAAAP/4A//gAAAAAAP/4A//wAAAAAAf/4A///////////4Af//////////wAf//////////wAf//////////wAf//////////wAP//////////gAP//////////gAH//////////AAH//////////AAD/////////+AAB/////////8AAA/////////4AAAP////////gAAAD///////+AAAAAf//////4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/gAAAAAAAAAAP/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/AAAAAAAAAAA//AAAAAAAAAAA/+AAAAAAAAAAB/8AAAAAAAAAAD//////////gAH//////////gAP//////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH/4AAAAB/gAAD//4AAAAf/gAAP//4AAAB//gAA///4AAAH//gAB///4AAAf//gAD///4AAA///gAH///4AAD///gAP///4AAH///gAP///4AAP///gAf///4AAf///gAf///4AB////gAf///4AD////gA////4AH////gA////4Af////gA////4A/////gA//wAAB/////gA//gAAH/////gA//gAAP/////gA//gAA///8//gA//gAD///w//gA//wA////g//gA////////A//gA///////8A//gA///////4A//gAf//////wA//gAf//////gA//gAf/////+AA//gAP/////8AA//gAP/////4AA//gAH/////gAA//gAD/////AAA//gAB////8AAA//gAA////wAAA//gAAP///AAAA//gAAD//8AAAA//gAAAP+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB/+AAAAAD/wAAB//8AAAAP/wAAB///AAAA//wAAB///wAAB//wAAB///4AAD//wAAB///8AAH//wAAB///+AAP//wAAB///+AAP//wAAB////AAf//wAAB////AAf//wAAB////gAf//wAAB////gA///wAAB////gA///wAAB////gA///w//AAf//wA//4A//AAA//wA//gA//AAAf/wA//gB//gAAf/wA//gB//gAAf/wA//gD//wAA//wA//wH//8AB//wA///////////gA///////////gA///////////gA///////////gAf//////////AAf//////////AAP//////////AAP/////////+AAH/////////8AAH///+/////4AAD///+f////wAAA///8P////gAAAf//4H///+AAAAH//gB///wAAAAAP4AAH/8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/wAAAAAAAAAA//wAAAAAAAAAP//wAAAAAAAAB///wAAAAAAAAf///wAAAAAAAH////wAAAAAAA/////wAAAAAAP/////wAAAAAB//////wAAAAAf//////wAAAAH///////wAAAA////////wAAAP////////wAAA///////H/wAAA//////wH/wAAA/////8AH/wAAA/////AAH/wAAA////gAAH/wAAA///4AAAH/wAAA//+AAAAH/wAAA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gAAAAAAAAH/4AAAAAAAAAAH/wAAAAAAAAAAH/wAAAAAAAAAAH/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//8AAA/////+B///AAA/////+B///wAA/////+B///4AA/////+B///8AA/////+B///8AA/////+B///+AA/////+B////AA/////+B////AA/////+B////AA/////+B////gA/////+B////gA/////+B////gA/////+A////gA//gP/gAAB//wA//gf/AAAA//wA//gf/AAAAf/wA//g//AAAAf/wA//g//AAAA//wA//g//gAAA//wA//g//+AAP//wA//g////////gA//g////////gA//g////////gA//g////////gA//g////////AA//gf///////AA//gf//////+AA//gP//////+AA//gH//////8AA//gD//////4AA//gB//////wAA//gA//////AAAAAAAH////8AAAAAAAA////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//////gAAAAB///////+AAAAH////////gAAAf////////4AAB/////////8AAD/////////+AAH//////////AAH//////////gAP//////////gAP//////////gAf//////////wAf//////////wAf//////////wAf//////////wAf//////////4A//wAD/4AAf/4A//gAH/wAAP/4A//gAH/wAAP/4A//gAP/wAAP/4A//gAP/4AAf/4A//wAP/+AD//4A///wP//////4Af//4P//////wAf//4P//////wAf//4P//////wAf//4P//////wAP//4P//////gAP//4H//////gAH//4H//////AAH//4D/////+AAD//4D/////8AAB//4B/////4AAA//4A/////wAAAP/4AP////AAAAB/4AD///4AAAAAAAAAH/8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//AAAAAAAAAAA//gAAAAAAAAAA//gAAAAAAAAAA//gAAAAAAADgA//gAAAAAAP/gA//gAAAAAH//gA//gAAAAB///gA//gAAAAP///gA//gAAAD////gA//gAAAf////gA//gAAB/////gA//gAAP/////gA//gAB//////gA//gAH//////gA//gA///////gA//gD///////gA//gf///////gA//h////////gA//n////////gA//////////gAA/////////AAAA////////wAAAA///////4AAAAA///////AAAAAA//////4AAAAAA//////AAAAAAA/////4AAAAAAA/////AAAAAAAA////8AAAAAAAA////gAAAAAAAA///+AAAAAAAAA///4AAAAAAAAA///AAAAAAAAAA//4AAAAAAAAAA/+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//gB///wAAAAP//4H///+AAAA///8P////gAAB///+f////4AAD///+/////8AAH/////////+AAH//////////AAP//////////gAP//////////gAf//////////gAf//////////wAf//////////wAf//////////wA///////////wA//4D//wAB//4A//wB//gAA//4A//gA//gAAf/4A//gA//AAAf/4A//gA//gAAf/4A//wB//gAA//4A///P//8AH//4Af//////////wAf//////////wAf//////////wAf//////////wAf//////////gAP//////////gAP//////////AAH//////////AAD/////////+AAD///+/////8AAB///8f////wAAAf//4P////AAAAH//wD///8AAAAA/+AAf//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//gAAAAAAAAB///+AA/+AAAAP////gA//wAAAf////wA//4AAB/////4A//8AAD/////8A//+AAD/////+A///AAH/////+A///AAP//////A///gAP//////A///gAf//////A///wAf//////A///wAf//////A///wAf//////A///wA///////AB//4A//4AD//AAP/4A//gAB//AAP/4A//gAA//AAP/4A//gAA/+AAP/4A//gAB/8AAP/4A//wAB/8AAf/4Af//////////wAf//////////wAf//////////wAf//////////wAf//////////wAP//////////gAP//////////gAH//////////AAH/////////+AAD/////////8AAB/////////4AAAf////////wAAAP////////AAAAB///////4AAAAAD/////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/AAB/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="), 46, atob("EiAnGicnJycnJycnEw=="), 78 + (scale << 8) + (1 << 16));
};

Graphics.prototype.setFontAntonSmall = function(scale) {
  // Actual height 53 (52 - 0)
  g.setFontCustom(atob("AAAAAAAAAAAAAAAAAAAAAAAAAAf8AAAAAAAAf8AAAAAAAAf8AAAAAAAAf8AAAAAAAAf8AAAAAAAAf8AAAAAAAAf8AAAAAAAAf8AAAAAAAAf8AAAAAAAAf8AAAAAAAAf8AAAAAAAAAAAAAAAAAAAAMAAAAAAAAD8AAAAAAAA/8AAAAAAAf/8AAAAAAH//8AAAAAB///8AAAAA////8AAAAP////8AAAD/////8AAB//////8AAf//////8AH///////4A///////+AA///////AAA//////wAAA/////8AAAA////+AAAAA////gAAAAA///4AAAAAA//8AAAAAAA//AAAAAAAA/wAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH/////wAAA//////8AAB//////+AAH///////gAH///////gAP///////wAf///////4Af///////4A////////8A////////8A////////8A//AAAAD/8A/8AAAAA/8A/8AAAAA/8A/8AAAAA/8A/+AAAAB/8A////////8A////////8A////////8Af///////4Af///////4AP///////wAP///////wAH///////gAD///////AAA//////8AAAP/////wAAAAAAAAAAAAAAAAAAAAAAAfwAAAAAAAA/4AAAAAAAA/4AAAAAAAB/wAAAAAAAB/wAAAAAAAD/wAAAAAAAD/gAAAAAAAH///////8AP///////8A////////8A////////8A////////8A////////8A////////8A////////8A////////8A////////8A////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH/4AAAP8AA//4AAA/8AB//4AAH/8AH//4AAP/8AP//4AA//8AP//4AB//8Af//4AD//8Af//4AP//8A///4Af//8A///4A///8A///4D///8A//AAH///8A/8AAP///8A/8AA//+/8A/8AD//8/8A/+Af//w/8A//////g/8A/////+A/8A/////8A/8Af////4A/8Af////wA/8AP////AA/8AP///+AA/8AH///8AA/8AD///wAA/8AA///AAA/8AAP/4AAA/8AAAAAAAAAAAAAAAAAAAAAAH4AAf/gAAA/4AAf/8AAD/4AAf//AAH/4AAf//gAP/4AAf//wAP/4AAf//wAf/4AAf//4Af/4AAf//4A//4AAf//8A//4AAf//8A//4AAP//8A//A/8AB/8A/8A/8AA/8A/8B/8AA/8A/8B/8AA/8A/+D//AB/8A////////8A////////8A////////8Af///////4Af///////4Af///////wAP///////gAH//9////gAD//4///+AAB//wf//4AAAP/AH//gAAAAAAAAAAAAAAAAAAAAAAAAAAAH/wAAAAAAB//wAAAAAAP//wAAAAAD///wAAAAA////wAAAAH////wAAAB/////wAAAf/////wAAD//////wAA///////wAA/////h/wAA////wB/wAA///8AB/wAA///AAB/wAA//gAAB/wAA////////8A////////8A////////8A////////8A////////8A////////8A////////8A////////8A////////8A////////8A////////8AAAAAAB/wAAAAAAAB/wAAAAAAAB/wAAAAAAAAAAAAAAAAAAAAAAAAAAAP/4AA////4P/+AA////4P//AA////4P//gA////4P//wA////4P//wA////4P//4A////4P//4A////4P//8A////4P//8A////4P//8A/8H/AAB/8A/8H+AAA/8A/8P+AAA/8A/8P+AAA/8A/8P/gAD/8A/8P/////8A/8P/////8A/8P/////8A/8P/////4A/8H/////4A/8H/////wA/8D/////wA/8B/////gA/8A////+AA/8AP///4AAAAAB///AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////wAAAf/////8AAB///////AAH///////gAP///////wAP///////wAf///////4Af///////4A////////8A////////8A////////8A/+AH/AB/8A/8AP+AA/8A/4Af+AA/8A/8Af+AA/8A/8Af/gH/8A//4f////8A//4f////8A//4f////8Af/4f////4Af/4f////4AP/4P////wAP/4P////gAH/4H////AAD/4D///+AAB/4B///4AAAP4AP//gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/8AAAAAAAA/8AAAAAAAA/8AAAAAB8A/8AAAAB/8A/8AAAAf/8A/8AAAH//8A/8AAA///8A/8AAH///8A/8AA////8A/8AD////8A/8Af////8A/8B/////8A/8P/////8A/8//////8A////////AA///////AAA//////gAAA/////4AAAA/////AAAAA////4AAAAA////AAAAAA///8AAAAAA///gAAAAAA//+AAAAAAA//wAAAAAAA/+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH/gD//gAAA//4P//8AAD//8f///AAH//+////gAH///////wAP///////4AP///////8Af///////8Af///////+Af///////+A////////+A//B//AB/+A/+A/+AA/+A/8Af+AA/+A/+Af+AA/+A//A//AB/+A////////+Af///////+Af///////+Af///////8Af///////8AP///////4AH///////4AH//+////wAD//+////AAA//4P//+AAAP/gH//wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//gAfgAAA///8A/8AAB///+A//AAH////A//gAH////g//wAP////g//wAf////w//4Af////w//4A/////w//8A/////w//8A/////w//8A//gP/wA/8A/8AD/wA/8A/8AD/wAf8A/8AD/gA/8A/+AH/AB/8A////////8A////////8A////////8Af///////4Af///////4Af///////wAP///////wAH///////gAD//////+AAA//////4AAAP/////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP+AA/4AAAAP+AA/4AAAAP+AA/4AAAAP+AA/4AAAAP+AA/4AAAAP+AA/4AAAAP+AA/4AAAAP+AA/4AAAAP+AA/4AAAAP+AA/4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="), 46, atob("DhgeFB4eHh4eHh4eDw=="), 60 + (scale << 8) + (1 << 16));
};
//-----------------------------------------------------------------------
//                VARIABLES  GENERALES
//-----------------------------------------------------------------------
var counterInterval;
var x = g.getWidth() / 2;
var y = g.getHeight() / 2;

//-----------------------------------------------------------------------
//                FONCTIONS UTILITAIRES
//-----------------------------------------------------------------------
function Tsleep(ms) {
  var debut;
  var ok="0";
  var maintenant;
   
  debut=Date.now();
  while (ok=="0") {
    if (boutton ==1 ) { ok="1"; boutton=0;}
    else {
       maintenant=Date.now();
       if (maintenant-debut < ms ) {ok="0";}
       else {ok="1"; }
        }
  }
}

//--------------------------------------
function set_Aff() {
  g.clear();
  Bangle.drawWidgets();
  g.setFontAlign(0,0); // center font
  g.setFont("Vector",40); // vector font, 80px 
  g.setColor(0,0,0);
}

//-------------------------------------------------------
// temperatures pression, altitude 
//
var history_T = [];var history_P = [];var history_A = [];
var temperature;var pression;var altitude;
var data;

function acqui_press() { 
  
  Bangle.getPressure().then(data => { 
        // console.log(data);
        suite_press (data);
        return;
  });
}
 
//------------------------------
function suite_press(data) {
  var temp=data.temperature;
  var press=data.pressure;
  var alti=data.altitude;
  //console.log("temp:",temp,"press:",press,"  alti:",alti);
  
    // moyenne de 5 temperatures
  while (history_T.length>4) history_T.shift();
  history_T.push(temp);
  temperature = E.sum(history_T) / history_T.length;
  
  temperature=temperature.toString();
  var point=temperature.indexOf(".");
  if (point==0) {
        point=temperature.length;temperature = temperature.substring(0,point);}
  else {
        temperature = temperature.substring(0,point)+"°"+temperature.substring(point+1,point+2);}
  console.log("Temp:",temperature);

  // pression  : moyenne de 5 
  while (history_P.length>4) history_P.shift();
  history_P.push(press);
  pression = E.sum(history_P) / history_P.length;
  
  pression=parseInt(pression);
  console.log("Pression:", pression);
  
  // altitude : moyenne de 5 
  while (history_A.length>4) history_A.shift();
  history_A.push(alti);
  altitude = E.sum(history_A) / history_A.length;
  
  altitude=parseInt(altitude);
  console.log("Altitude:",altitude);
}

//------------------------------------------------------

var calendar = [];
var current = [];
var next = [];
var nb_heures;
var nb_minutes;
var titre;

function updateCalendar() {
  calendar = require("Storage").readJSON("android.calendar.json",true)||[];
  calendar = calendar.filter(e => isActive(e) || getTime() <= e.timestamp);
  calendar.sort((a,b) => a.timestamp - b.timestamp);

  current = calendar.filter(isActive);
  next = calendar.filter(e=>!isActive(e));
}

function isActive(event) {
  var timeActive = getTime() - event.timestamp;
  return timeActive >= 0 && timeActive <= event.durationInSeconds;
}

//------------------------------------------------------
function timeToNext() {

  if (next.length !=0) {
     var inter=next[0].timestamp-getTime();
     console.log(inter);
     nb_heures=Math.floor(inter/3600);
     nb_minutes =Math.floor((inter-3600*nb_heures)/60);
     console.log(nb_heures, nb_minutes);
     titre=next[0].title;
  } else {
    nb_heures=0; nb_minutes=0;
  }
  
}

//-------------------------------------------------------------------------------------------
//                AFFICHAGES 
//-------------------------------------------------------------------------------------------
var altern=0;

function aff_principal() {

  ecran=1;

  set_Aff();
  acqui_press();
  x = g.getWidth() / 2;
  y = (g.getHeight() / 2) -5;

  //
  // --------- HEURE et MINUTE ------------------
  //
  var date = new Date();
  
  var hh=date.getHours().toString();
  //if (hh.length==1) { hh="0"+hh; }
  //console.log(`longueur ${hh} ${hh.length}`);
  var aff=hh+":";
  
  var mm=date.getMinutes().toString();
  if (mm.length==1) { aff=aff+"0"; }
  //console.log(`longueur ${mm} ${mm.length}`);
  aff=aff+mm;
  
  console.log(altern);
  
  //  rectangle 
  if ( altern==0 ) {
    g.setColor(1,0,0);
    g.fillRect (2,28,172,103);
    g.setColor(1,1,1);
    altern=1;
  } 
  else {
    if (altern==1) { g.setColor(0,0,1); altern=2; } 
    else { g.setColor(1,0,0); altern=0; }
  }

  y-=11;
  g.setFontAlign(0, 0).setFont("Anton").drawString(aff, x, y); // draw time
  
  //-----------------------------------------------
  //       JOUR MOIS 
  //
  var jourSem = "";
  var calWeek = false;

  jourSem = require("locale").dow(date, calWeek ? 1 : 0);
  deb=jourSem.substring(0,1);
  deb=deb.toUpperCase();
  jourSem = deb+jourSem.substring(1,3);
  // DATE MOIS 
  var dateOnMain = "Long";
  var dateStr = (dateOnMain === "ISO8601" ? isoStr(date) : require("locale").date(date, (dateOnMain === "Long" ? 0 : 1)));
  // année 4 derniers 
  // dateStr.substring(0,dateStr.length-4);
  var jourMois= dateStr.substring(0,2);
  var blanc=dateStr.indexOf(" ");
  var mois =(dateStr.substring(blanc,dateStr.length)).substring(0,4);

  g.setColor(0,0,0); // noir
 
  x+=4; y+=55;
  dateStr=jourSem+"        ";
  g.setFont("8x12",3);
  g.drawString(dateStr, x, y);
  //
  x+=40; y+=1;
  dateStr=jourMois+"    ";
  g.setFont("Vector",40);
  g.drawString(dateStr,x,y);
  //
  x+=6; y+=0;
  dateStr=mois.toUpperCase();
  g.setFont("8x12",3);
  g.drawString(dateStr,x,y);
  
  //-----------------------------------------------
  //           CALENDRIER 
  updateCalendar();
  timeToNext();
  x=5; y+=32;
  if (nb_heures!=0 || nb_minutes!=0 ) {
  calen=nb_heures+":"+nb_minutes+" "+titre;
  } else {
  calen= "sans éléments" ;
  }
    
  g.setFont("Vector",20);
  g.setFontAlign(-1, 0);
  g.drawString(calen,x,y);
  
  if ((nb_heures==1) && (nb_minutes==0)) {
     Bangle.buzz(1000);
  }
  if ((nb_heures==0) && (nb_minutes==30)) {
     Bangle.buzz(2000); Tsleep(1000);Bangle.buzz(1000);
  }
    if ((nb_heures==0) && (nb_minutes==30)) {
     i=0;
     while(i<4) { Bangle.buzz(500);Tsleep(500); }
  }
  
}

//-----------------------------------------------------------------------

function aff_second() {
  
  set_Aff();
  ecran=2;
  console.log("affichage second");
  g.setFont("Vector",24);
  
//  console.log(counterInterval);
//  if (counterInterval!=undefined) {clearInterval(counterInterval);counterInterval=undefined;}
  
  var batt=E.getBattery().toString()+ "%";
  
  g.setFontAlign(-1, 0);
  y=40; g.drawString("B:"+batt, x, y);
  y+=30;g.drawString(" T:"+temperature, x, y);
  tend=pression-1013; console.log (tend);
  y+=30;g.drawString("Prs:"+pression+" "+tend, x, y);
  y+=30;g.drawString(" Alt:"+altitude+" m", x, y);  
  
  Tsleep(5000);
}

//-------------------------------------------------------
//          PAGE CALENDRIER 


function zp(str) {
  return ("0"+str).substr(-2);
}

function drawEventHeader(event, y) {

  g.setFont("Vector", 24);

  var time = isActive(event) ? new Date() : new Date(event.timestamp * 1000);
  var timeStr = zp(time.getHours()) + ":" + zp(time.getMinutes());

  y += 26;
  x=5;
  
  if (isActive(event)) {
     g.drawString(zp(time.getDate())+"." + require("locale").month(time,1),x,y-21);
     g.drawString(timeStr, 100, y-21);
    
  } else {
    var offset = 0-time.getTimezoneOffset()/1440;
    var days = Math.floor((time.getTime()/1000)/86400+offset)-Math.floor(getTime()/86400+offset);
    if(days > 0) {
      g.setFont("Vector", 24);
      var daysStr = days===1?/*LANG*/"Demain":/*LANG*/"J+"+days;
      g.drawString(daysStr,x,y-21);
    }
    g.drawString(timeStr, 100, y-21);
  }
  return y;
}

function drawEventBody(event, y) {

  g.setFont("Vector", 20);
  var lines = g.wrapString(event.title, g.getWidth()-10);
  if (lines.length > 2) {
    lines = lines.slice(0,2);
    lines[1] = lines[1].slice(0,-3)+"...";
  }
  g.drawString(lines.join('\n'), 5, y);
  y+=20 * lines.length;
  if(event.location) {
    g.drawImage(atob("DBSBAA8D/H/nDuB+B+B+B3Dn/j/B+A8A8AYAYAYAAAAAAA=="),5,y);
    g.drawString(event.location, 20, y);
    y+=20;
  }
  y+=5;
  return y;
}

function drawEvent(event, y) {
  y = drawEventHeader(event, y);
  y = drawEventBody(event, y);
  return y;
}

var curEventHeight = 0;

function drawCurrentEvents(y) {
  
  g.setColor(0,0,1);
  g.clearRect(5, y, g.getWidth() - 5, y + curEventHeight);
  curEventHeight = y;

  if(current.length === 0) {
    y = drawEvent({timestamp: getTime(), durationInSeconds: 100}, y);
  } else {
    y = drawEventHeader(current[0], y);
    for (var e of current) {
      y = drawEventBody(e, y);
    }
  }
  curEventHeight = y - curEventHeight;
  return y;
}

function drawFutureEvents(y) {
  g.setColor(g.theme.fg);
  for (var e of next) {
    y = drawEvent(e, y);
    if(y>g.getHeight())break;
  }
  return y;
}

function fullRedraw() {
  set_Aff();
  g.setFontAlign(-1, 0);
  g.clearRect(5,24,g.getWidth()-5,g.getHeight());
  updateCalendar();
  y = 30;
  y = drawCurrentEvents(y);
  drawFutureEvents(y);
  return;
}

//-----------------------------------------------------------------------

function aff_tiers() {

  ecran=3;
  console.log("affichage tiers");
  fullRedraw();   
  Tsleep(4000);

  // Show launcher when middle button press
  // Bangle.setUI("clock");
  
  Tsleep(3000);
  
  return;
}

//-----------------------------------------------------------------------
//                         PRINCIPAL
//--------------------                -----------------------------------

function aiguillage (){
  console.log("Boutton");
  boutton=1;
  if (ecran==1) { aff_second();}
  else { if (ecran==2) { aff_tiers();} 
         else { aff_principal();}
        }
}

//------------------
function general() {

  aff_principal();

  if (!counterInterval)
      counterInterval = setInterval(aff_principal, 30000);
  
}

//--------------------     MAIN           -----------------------------------

Bangle.setBarometerPower(true);
//setTimeout(general,5000);

setWatch(aiguillage ,BTN1,{edge:"rising", debounce:30, repeat:true});

acqui_press();
general ();


// Register hooks for LCD on/off event and screen lock on/off event
//Bangle.on('lcdPower', on => {   general(); });
//Bangle.on('lock', on => { general(); });

// Load widgets
Bangle.loadWidgets();

// end of file
